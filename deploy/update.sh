#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ git pull
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy/update.sh [branch]
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç main branch

set -e

APP_DIR="/var/www/santa-app"
BRANCH=${1:-main}

echo "üîÑ –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
echo "üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $APP_DIR"
echo "üåø –í–µ—Ç–∫–∞: $BRANCH"

cd $APP_DIR

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: $APP_DIR –Ω–µ —è–≤–ª—è–µ—Ç—Å—è git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º"
    exit 1
fi

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ, –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã)
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ git..."
git fetch origin
git reset --hard origin/$BRANCH

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
cd backend
npm install --production

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend..."
cd ../frontend
npm install --production

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ frontend
echo "üèóÔ∏è  –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ frontend..."
# –û—á–∏—â–∞–µ–º –∫—ç—à Next.js –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
if [ -d ".next" ]; then
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Next.js..."
    rm -rf .next
fi
npm run build

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
if [ ! -f ".next/prerender-manifest.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Å–±–æ—Ä–∫–∞ frontend –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ"
    exit 1
fi
echo "‚úÖ Frontend —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 restart santa-backend
pm2 restart santa-frontend

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 status

echo ""
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞: https://santa.richislav.com"
